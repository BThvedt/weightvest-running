option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /web
    memory_limit: 1024M
    max_execution_time: 60
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /sites/default/files: /web/sites/default/files

files:
  "/etc/httpd/conf.d/drupal.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      LoadModule rewrite_module modules/mod_rewrite.so
      
      <Directory "/var/app/current/web">
        AllowOverride All
        Options -Indexes +FollowSymLinks +MultiViews
        DirectoryIndex index.php index.html
        Require all granted
        
        RewriteEngine On
        RewriteBase /
        
        # Skip real files and directories
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !=/favicon.ico
        RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]
      </Directory>
      
      # Serve static files directly
      <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt)$">
        Header set Cache-Control "public, max-age=2592000"
      </LocationMatch>

container_commands:
  01_create_directories:
    command: "mkdir -p /var/app/current/web/sites/default/files"
  02_fix_permissions:
    command: "chmod -R 755 /var/app/current/web/sites/default/files"
    ignoreErrors: true
  03_fix_static_permissions:
    command: "find /var/app/current/web -type f -name '*.css' -o -name '*.js' -o -name '*.png' -o -name '*.jpg' -o -name '*.gif' -o -name '*.ico' -o -name '*.svg' | xargs chmod 644"
    ignoreErrors: true

commands:
  01_install_mod_rewrite:
    command: "yum install -y mod_rewrite"
    ignoreErrors: true
option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /web
    memory_limit: 1024M
    max_execution_time: 60

files:
  "/etc/nginx/conf.d/drupal_override.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
          listen 8080;
          server_name _;
          root /var/app/current/web;
          index index.php index.html;

          # Handle static files
          location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt|map)$ {
              expires 1y;
              add_header Cache-Control "public, immutable";
              try_files $uri =404;
          }

          # Handle Drupal files directory
          location ^~ /sites/default/files/ {
              expires 30d;
              add_header Cache-Control "public";
              try_files $uri =404;
          }

          # Main Drupal routing - this is the key part
          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }

          # PHP handler
          location ~ \.php$ {
              try_files $uri =404;
              fastcgi_pass unix:/var/run/php-fpm/www.sock;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param QUERY_STRING $query_string;
              fastcgi_param REQUEST_METHOD $request_method;
              fastcgi_param CONTENT_TYPE $content_type;
              fastcgi_param CONTENT_LENGTH $content_length;
              fastcgi_param SCRIPT_NAME $fastcgi_script_name;
              fastcgi_param REQUEST_URI $request_uri;
              fastcgi_param DOCUMENT_URI $document_uri;
              fastcgi_param DOCUMENT_ROOT $document_root;
              fastcgi_param SERVER_PROTOCOL $server_protocol;
              fastcgi_param GATEWAY_INTERFACE CGI/1.1;
              fastcgi_param SERVER_SOFTWARE nginx;
              fastcgi_param REMOTE_ADDR $remote_addr;
              fastcgi_param REMOTE_PORT $remote_port;
              fastcgi_param SERVER_ADDR $server_addr;
              fastcgi_param SERVER_PORT $server_port;
              fastcgi_param SERVER_NAME $server_name;
          }

          # Security
          location ~ /\. {
              deny all;
              return 404;
          }

          location ~ /\.ht {
              deny all;
              return 404;
          }
      }

container_commands:
  01_remove_default_nginx:
    command: "rm -f /etc/nginx/conf.d/default.conf"
    ignoreErrors: true
  02_create_directories:
    command: "mkdir -p /var/app/current/web/sites/default/files"
  03_fix_permissions:
    command: "chmod -R 755 /var/app/current/web/sites/default/files"
    ignoreErrors: true
  04_test_nginx:
    command: "nginx -t"
    ignoreErrors: true
  05_reload_nginx:
    command: "nginx -s reload"
    ignoreErrors: true
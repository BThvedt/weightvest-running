option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /web
    memory_limit: 1024M
    max_execution_time: 60

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_fix_drupal_routing.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Backup the original default.conf
      cp /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.backup
      
      # Create new default.conf with Drupal routing
      cat > /etc/nginx/conf.d/default.conf << 'EOF'
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name _;
          root /var/app/current/web;
          index index.php index.html index.htm;

          # Handle static files
          location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt|map)$ {
              expires 1y;
              add_header Cache-Control "public, immutable";
              access_log off;
          }

          # Handle Drupal files directory
          location ^~ /sites/default/files/ {
              expires 30d;
              add_header Cache-Control "public";
          }

          # Main location - THIS IS THE KEY
          location / {
              try_files $uri $uri/ /index.php?$query_string;
          }

          # Handle PHP files
          location ~ \.php$ {
              try_files $uri =404;
              fastcgi_split_path_info ^(.+\.php)(/.+)$;
              fastcgi_pass 127.0.0.1:9000;
              fastcgi_index index.php;
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $fastcgi_path_info;
          }

          # Security
          location ~ /\. {
              deny all;
          }
      }
      EOF
      
      # Test and reload nginx
      nginx -t && nginx -s reload

container_commands:
  01_create_directories:
    command: "mkdir -p /var/app/current/web/sites/default/files"
  02_fix_permissions:
    command: "chmod -R 755 /var/app/current/web/sites/default/files"
    ignoreErrors: true
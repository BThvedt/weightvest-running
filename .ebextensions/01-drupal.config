option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /web
    memory_limit: 1024M
    max_execution_time: 60
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /sites/default/files: /web/sites/default/files

files:
  "/etc/nginx/conf.d/drupal.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
          listen 80;
          server_name _;
          root /var/app/current/web;
          index index.php index.html;

          # Handle static files
          location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt)$ {
              expires 30d;
              add_header Cache-Control "public, immutable";
              try_files $uri =404;
          }

          # Handle Drupal files directory
          location ^~ /sites/default/files/ {
              try_files $uri =404;
          }

          # Main Drupal location
          location / {
              try_files $uri $uri/ @drupal;
          }

          # Drupal fallback
          location @drupal {
              rewrite ^/(.*)$ /index.php?q=$1 last;
          }

          # Handle PHP files
          location ~ \.php$ {
              include fastcgi_params;
              fastcgi_pass unix:/var/run/php-fpm/www.sock;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $fastcgi_path_info;
          }

          # Deny access to sensitive files
          location ~ /\. {
              deny all;
          }

          location ~ ~$ {
              deny all;
          }
      }

container_commands:
  01_create_directories:
    command: "mkdir -p /var/app/current/web/sites/default/files"
  02_fix_permissions:
    command: "chmod -R 755 /var/app/current/web/sites/default/files"
    ignoreErrors: true
  03_restart_nginx:
    command: "service nginx reload"
    ignoreErrors: true
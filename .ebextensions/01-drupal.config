option_settings:
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /web
    memory_limit: 1024M
    max_execution_time: 60

files:
  "/etc/nginx/conf.d/default.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name _;
          root /var/app/current/web;
          index index.php index.html;

          # Security headers
          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-Content-Type-Options "nosniff" always;

          # Handle favicon
          location = /favicon.ico {
              log_not_found off;
              access_log off;
          }

          # Handle robots.txt
          location = /robots.txt {
              allow all;
              log_not_found off;
              access_log off;
          }

          # Deny access to sensitive files
          location ~ /\. {
              deny all;
              return 404;
          }

          location ~ ~$ {
              deny all;
              return 404;
          }

          # Handle static files
          location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt|map)$ {
              expires 1y;
              add_header Cache-Control "public, immutable";
              try_files $uri =404;
          }

          # Handle Drupal files directory
          location ^~ /sites/default/files/ {
              expires 30d;
              add_header Cache-Control "public";
              try_files $uri =404;
          }

          # Handle core, modules, themes directories
          location ^~ /core/ {
              try_files $uri =404;
          }

          location ^~ /modules/ {
              try_files $uri =404;
          }

          location ^~ /themes/ {
              try_files $uri =404;
          }

          # Main location block for Drupal
          location / {
              # First attempt to serve request as file, then
              # as directory, then fall back to index.php
              try_files $uri $uri/ /index.php?$query_string;
          }

          # Handle PHP files
          location ~ \.php$ {
              try_files $uri =404;
              fastcgi_split_path_info ^(.+\.php)(/.+)$;
              include fastcgi_params;
              fastcgi_pass unix:/var/run/php-fpm/www.sock;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $fastcgi_path_info;
              fastcgi_param QUERY_STRING $query_string;
              fastcgi_intercept_errors on;
          }

          # Deny access to .htaccess files
          location ~ /\.ht {
              deny all;
              return 404;
          }
      }

container_commands:
  01_backup_default_conf:
    command: "cp /etc/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf.bak"
    ignoreErrors: true
  02_remove_conflicting_configs:
    command: "rm -f /etc/nginx/conf.d/drupal.conf"
    ignoreErrors: true
  03_test_nginx_config:
    command: "nginx -t"
    ignoreErrors: true
  04_reload_nginx:
    command: "nginx -s reload"
    ignoreErrors: true
# Drupal configuration for Nginx on AWS Elastic Beanstalk

# Security - deny access to sensitive files (move to top for priority)
location ~ /\.(?!well-known) {
    deny all;
    return 404;
}

location ~ ~$ {
    deny all;
    return 404;
}

# Deny access to various Drupal files
location ~* \.(engine|inc|install|make|module|profile|po|sh|.*sql|theme|twig|tpl(\.php)?|xtmpl|yml|yaml)(~|\.sw[op]|\.bak|\.orig|\.save)?$|^(\.(?!well-known).*|Entries.*|Repository|Root|Tag|Template|composer\.(json|lock)|web\.config)$|^#.*#$|\.php(~|\.sw[op]|\.bak|\.orig|\.save)$ {
    deny all;
    return 404;
}

# Handle favicon and robots
location = /favicon.ico {
    log_not_found off;
    access_log off;
}

location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
}

# Handle Drupal files directory with proper headers
location ~ ^/sites/.*/files/styles/ {
    try_files $uri @rewrite;
}

location ~ ^(/[a-z\-]+)?/system/files/ {
    try_files $uri /index.php?$query_string;
}

# Private files
location ~ ^/sites/.*/private/ {
    return 403;
}

# Handle static files for core, modules, themes, profiles, sites
location ~ ^(/[a-z\-]+)?/(core|modules|profiles|themes|sites)/.*\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|txt|html|map)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri @rewrite;
    # Remove the =404 fallback to allow Drupal to handle missing files
}

# Main location block - this should be after the more specific rules
location / {
    try_files $uri /index.php?$query_string;
}

# Rewrite location for Drupal
location @rewrite {
    rewrite ^/(.*)$ /index.php?q=$1;
}

# Handle image styles
location ~ ^/sites/.*/files/imagecache/ {
    try_files $uri @rewrite;
}

location ~ ^/sites/.*/files/styles/ {
    try_files $uri @rewrite;
}

# PHP handler with proper FastCGI params
location ~ ^/index\.php$ {
    try_files $uri =404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    # AWS Elastic Beanstalk PHP-FPM socket location
    fastcgi_pass unix:/var/run/php-fpm/www.sock;
    fastcgi_index index.php;
    
    # Include standard FastCGI params if available, otherwise define inline
    include fastcgi_params;
    
    # Override or set additional params
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param QUERY_STRING $query_string;
    
    # Drupal-specific headers
    fastcgi_param HTTP_PROXY "";
    
    fastcgi_intercept_errors on;
    fastcgi_read_timeout 300;
}

# Deny access to other PHP files
location ~ \.php$ {
    return 404;
}

# Additional security headers (optional but recommended)
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;